# 视频分类（输入：视频 输出：视频）

## 简介

深度卷积神经网络AlexNet赢得了2012年ILSVRC的冠军，从那时起，CNN家族就拿下了这一比赛，并超过了人类视觉5%~10%的准确率水平，基于CNN网络模型的图像分类也成为了AI领域最为活跃的研究领域。本应用提供了基于Atlas 200 DK或者AI加速云服务器进行分类网络应用开发的Demo。


本项目是视频分类应用，旨在华为Atlas200DK和AI加速云服务器上实现读取本地视频作为输入，对视频帧中的物体进行识别分类，并将分类的结果在视频帧上展示出来。

## 总体设计

![输入图片说明](https://images.gitee.com/uploads/images/2020/0810/161429_a0487fb2_5408865.png "屏幕截图.png")



1. **运行管理资源申请：**用于初始化系统内部资源，ACL固定的调用流程。
2. **加载模型文件并构建输出内存：**从文件加载离线模型数据，根据内存中加载的模型获取模型的基本信息包含模型输入、输出数据的数据buffer大小；由模型的基本信息构建模型输出内存，为接下来的模型推理做好准备。
3. **读取本地视频并进行预处理：**使用opencv打开本地视频文件，循环读取每一帧图像数据，将图像数据缩放至模型要求的宽高比例；然后构建模型的输入数据。
4. **模型推理：**根据构建好的模型输入数据，调用模型推理接口，进行模型推理。
5. **解析推理结果：**根据模型输出，解析分类的结果，得到视频帧数据中检测到的物体类别，然后调用Presenter Agent的接口发送到主机端上部署好的Presenter Server服务进程，进行Web UI展示。
6. **Presenter Server接收推理结果：**Presenter Server根据接收到的推理结果，在每一帧图像数据上进行物体类别的标记，并将图像信息推送给主机端Web Ul，通过浏览器访问Presenter Server, 查看视频中的各类物体分类信息。

## 模型结构

![输入图片说明](https://images.gitee.com/uploads/images/2020/0810/161511_e5e94b94_5408865.jpeg "googlenet网络结构图.jpg")

## 原始模型

该模型来自GitHub：https://github.com/BVLC/caffe/tree/master/models/bvlc_googlenet  请从GitHub中获取模型网络结构，预训练模型等。

## 预处理

本应用预处理部分，使用opencv的capture.read接口循环读取视频帧，读取出来的是BGR格式。模型输入为224×224，因此需要把读取到的图像resize到224×224。Resize后对数据做归一化处理。如算法设计部分所言，该模型采用Lab色彩空间，因此需要把BGR格式转为Lab格式数据。该模型用L通道数据预测出可能的ab空间数据，所以要从Lab数据中分离出L通道数据。再对所得的数据减均值，即可得到模型需要的输入数据。

该模型算法需要BGR格式，输入视频帧的分辨率为224x224，并对颜色通道进行减均值。本应用图像预处理时opencv和AIPP分工处理：

opencv：

1. 从视频文件中循环获取一帧图像数据
2. 图像缩放为：224x224
3. 输出图像数据类型为：Uint8

AIPP:

1. 颜色通道减均值
2. 图像数据类型转换：Uint8->FP16(达芬奇推理的要求，模型最后实际的输入为fp16)

## 后处理

模型的输出为1000个float型数据，1000个float型数据代表1000中物体类别，每个float型数据为归一化数据范围0 ~ 1。代表该类物体识别的置信度，选取其中置信度最高的类别，作为图像的分类结果。

## 案例性能

单次处理时长（预处理->推理->后处理）：17.2 ms

单次推理时长（推理）：3.5 ms

## 可优化点

由性能可以看出，推理速度很快。但是预处理和后处理占用时间过长，导致单次处理时长较长。可以将预处理和后处理进行优化，使用DVPP替换OPENCV，或者使用单算子进行后处理，可以有效提升效率。