

# Softmax算子运行验证

## 功能描述

该样例实现了对[自定义算子Softmax](../../1_custom_op/doc/Softmax_CN.md)的功能验证，通过将自定义算子转换为单算子离线模型文件，然后通过AscendCL加载单算子模型文件进行运行。

说明：单算子模型文件的生成只依赖算子代码实现文件、算子原型定义、算子信息库，不依赖算子适配插件。

## 目录结构

```
├── inc                           //头文件目录
│   ├── common.h                  // 声明公共方法类，用于读取二进制文件
│   ├── operator_desc.h          //算子描述声明文件，包含算子输入/输出，算子类型以及输入描述与输出描述
│   ├── op_runner.h              //算子运行相关信息声明文件，包含算子输入/输出个数，输入/输出大小等
├── run                           // 单算子执行需要的文件存放目录
│   ├── out    // 单算子执行需要的可执行文件存放目录
│        └── test_data         // 测试数据存放目录
│           ├── config
│               └── acl.json       //用于进行~acl初始化，请勿修改此文件
│               └── softmax_op.json    // 算子描述文件，用于构造单算子模型文件
│           ├── data
│               └── generate_data.py    // 生成测试数据的脚本
├── src
│   ├── CMakeLists.txt    // 编译规则文件
│   ├── common.cpp         // 公共函数，读取二进制文件函数的实现文件
│   ├── main.cpp    // 将单算子编译为om文件并加载om文件执行，此文件中包含算子的相关配置，若验证其他单算子，基于此文件修改
│   ├── operator_desc.cpp     // 构造算子的输入与输出描述
│   ├── op_runner.cpp   // 单算子编译与运行函数实现文件
```

## 环境要求

-   操作系统及架构：CentOS x86\_64、CentOS aarch64、Ubuntu 18.04 x86\_64、Ubuntu 18.04 aarch64、EulerOS x86、EulerOS aarch64
-   芯片：Ascend 310、Ascend 310P、Ascend 910
-   python及依赖的库：Python3.7.*x*（3.7.0 ~ 3.7.11）、Python3.8.*x*（3.8.0 ~ 3.8.11）
-   已完成昇腾AI软件栈的部署。
-   已参考[custom\_op](../../1_custom_op)完成自定义算子的编译部署。

## 配置环境变量

- 开发环境上环境变量配置

  1. CANN-Toolkit包提供进程级环境变量配置脚本，供用户在进程中引用，以自动完成CANN基础环境变量的配置，配置示例如下所示

     ```
     . ${HOME}/Ascend/ascend-toolkit/set_env.sh
     ```

     “$HOME/Ascend”请替换“Ascend-cann-toolkit”包的实际安装路径。

  2. 算子编译依赖Python，以Python3.7.5为例，请以运行用户执行如下命令设置Python3.7.5的相关环境变量。

     ```
     #用于设置python3.7.5库文件路径
     export LD_LIBRARY_PATH=/usr/local/python3.7.5/lib:$LD_LIBRARY_PATH
     #如果用户环境存在多个python3版本，则指定使用python3.7.5版本
     export PATH=/usr/local/python3.7.5/bin:$PATH
     ```

     Python3.7.5安装路径请根据实际情况进行替换，您也可以将以上命令写入~/.bashrc文件中，然后执行source ~/.bashrc命令使其立即生效。

  3. 开发环境上，设置环境变量，配置AscendCL单算子验证程序编译依赖的头文件与库文件路径。
     
     设置以下环境变量后，编译脚本会根据“{DDK_PATH}环境变量值/runtime/include/acl”目录查找编译依赖的头文件，根据{NPU_HOST_LIB}环境变量指向的目录查找编译依赖的库文件。“$HOME/Ascend”请替换“Ascend-cann-toolkit”包的实际安装路径。

     - 当开发环境与运行环境的操作系统架构相同时，配置示例如下所示：

       ```
       export DDK_PATH=$HOME/Ascend/ascend-toolkit/latest
       export NPU_HOST_LIB=$DDK_PATH/runtime/lib64/stub
       ```

     - 当开发环境与运行环境的操作系统架构不同时，配置示例如下所示：
       
       例如，当开发环境为X86架构、运行环境为AArch64架构时，则涉及交叉编译，需在开发环境上安装AArch64架构的软件包，将{DDK_PATH}环境变量的路径指向AArch64架构的软件包安装目录（如下所示，注意arm64-linux仅作为示例说明，请以实际架构目录名称为准），便于使用与运行环境架构相同的软件包中的头文件和库文件来编译代码。

       ```
       export DDK_PATH=$HOME/Ascend/ascend-toolkit/latest/arm64-linux
       export NPU_HOST_LIB=$DDK_PATH/runtime/lib64/stub
       ```


- 运行环境上环境变量配置

  -   若运行环境上安装的“Ascend-cann-toolkit”包，环境变量设置如下：

      ```
      . ${HOME}/Ascend/ascend-toolkit/set_env.sh
      ```

  -   若运行环境上安装的“Ascend-cann-nnrt”包，环境变量设置如下：

      ```
      . ${HOME}/Ascend/nnrt/set_env.sh
      ```

  -   若运行环境上安装的“Ascend-cann-nnae”包，环境变量设置如下：

      ```
      . ${HOME}/Ascend/nnae/set_env.sh
      ```

    “$HOME/Ascend”请替换相关软件包的实际安装路径。




## 编译运行

1.  生成Softmax算子的单算子离线模型文件。
    1.  以运行用户（例如HwHiAiUser）登录开发环境，并进入样例工程的“acl\_execute\_softmax/run/out“目录。
    2.  在out目录下执行如下命令，生成单算子模型文件。

        **atc --singleop=test\_data/config/softmax\_op.json  --soc\_version=*Ascend310*  --output=op\_models**

        其中：

        -   singleop：算子描述的json文件。
        -   soc\_version：昇腾AI处理器的型号，此处以Ascend310为例，请根据实际情况替换。

        -   --output=op\_models：代表生成的模型文件存储在当前目录下的op\_models文件夹下。

        模型转换成功后，会生成如下文件：

        在当前目录的op\_models目录下生成单算子的模型文件**0\_SoftmaxV2\_0\_2\_8\_16\_0\_2\_8\_16.om**，命名规范为：序号+opType + 输入的描述\(dateType\_format\_shape\)+输出的描述。

        dataType以及format对应枚举值请从CANN软件所在目录下的“include/graph/types.h”文件中查看，枚举值从0开始依次递增。

        **说明：**模型转换时，会优先去查找自定义算子库去匹配模型文件中的算子。


2.  生成测试数据。

    进入样例工程目录的run/out/test\_data/data目录下，执行如下命令：

    **python3.7.5 generate\_data.py**

    会在当前目录下生成两个shape为\(8, 16\)，数据类型为floaot32的数据文件input\_0.bin，用于进行Softmax算子的验证。

3. 编译样例工程，生成单算子验证可执行文件。
   1. 切换到样例工程根目录acl\_execute\_softmax，然后在样例工程根目录下执行如下命令创建目录用于存放编译文件，例如，创建的目录为“build/intermediates/host“。

       **mkdir -p build/intermediates/host**

   2. 切换到“build/intermediates/host”目录，执行cmake命令生成编译文件。

      “../../../src“表示CMakeLists.txt文件所在的目录，请根据实际目录层级修改。

      DCMAKE_SKIP_RPATH需设置为TRUE，代表不会将rpath信息（即NPU_HOST_LIB配置的路径）添加到编译生成的可执行文件中去，可执行文件运行时会自动搜索实际设置的LD_LIBRARY_PATH中的动态链接库。

       -   当开发环境与运行环境操作系统架构相同时，执行如下命令编译。

           **cd build/intermediates/host**

           **cmake ../../../src -DCMAKE\_CXX\_COMPILER=g++ -DCMAKE\_SKIP\_RPATH=TRUE**

       -   当开发环境与运行环境操作系统架构不同时，需要使用交叉编译。

           例如，当开发环境为X86架构，运行环境为AArch64架构时，执行以下命令进行交叉编译。

           **cd build/intermediates/host**

           **cmake ../../../src -DCMAKE\_CXX\_COMPILER=aarch64-linux-gnu-g++ -DCMAKE\_SKIP\_RPATH=TRUE**



   3. 执行如下命令，生成可执行文件。

      **make**

      会在工程目录的“run/out“目录下生成可执行文件**execute\_softmax\_op**。


4.  在硬件设备的Host侧执行单算子验证文件。
    1.  以运行用户（例如HwHiAiUser）拷贝开发环境中样例工程acl\_execute\_softmax/run/目录下的out文件夹到运行环境任一目录，例如上传到/home/HwHiAiUser/HIAI\_PROJECTS/run\_softmax/目录下。

        **说明：**若您的开发环境即为运行环境，此拷贝操作可跳过。

    2.  在运行环境中执行execute\_softmax\_op文件，验证单算子模型文件。

        在/home/HwHiAiUser/HIAI\_PROJECTS/run\_softmax/out目录下执行如下命令：

        **chmod +x execute\_softmax\_op**

        **./execute\_softmax\_op**

        会有如下屏显信息（注意：由于数据生成脚本生成的数据文件是随机的，屏显显示的数据会有不同）：

        ```
        [INFO]  Input[0]:
               1.964     5.18075     8.34857     5.89489     6.94057     8.13515     1.64323     4.21575     3.59446     3.36891     1.16488      5.4633     1.66912     6.08848     3.85598     3.90269
             3.03632     7.83259     1.08189     1.78934     2.52593     5.17109     6.03337     2.68933     8.83906     6.13864     4.99742      8.4141     2.78913     7.59506     6.87752      5.8658
             6.03144      7.5082     5.73127     8.10299     3.49008     7.11084     6.99786     7.79289     7.41494     8.61127      5.2607     2.81838     2.63016      4.6929     3.33906     2.67384
             4.97893     5.61952     3.42433     8.79005      9.7224     6.40261     5.23827     6.80337     7.02011      5.2128     1.75835     9.01168     6.47643     1.35168     5.08609     3.41378
             7.44854     3.07921      6.3708     7.84267     5.86042     8.36725     8.94286     2.37981     9.04679      6.7751     6.30535     6.99987      9.3375     9.41325     3.41567     1.62766
             7.23167     1.01582     1.44395     8.02107     5.05319      9.9051     8.26118     7.80592     8.97341     7.72043     8.68981     2.44615     2.14303     8.94444     6.11917     6.17793
             4.25618     2.39497     3.62921     4.73749     2.17078     5.32865     6.18814     7.84277     4.54349     2.95626     8.41946     5.01646     5.16211     3.51067      9.6782     7.60835
             8.58792     1.69972     1.22532      3.5807     2.70074     1.37077     4.77957     1.79133     8.35138     5.00774     4.82327     1.40899     4.99465     4.45809     3.60725     1.89699
        [INFO]  Output[0]:
              0.000703057    0.017539    0.416653   0.0358224    0.101927     0.33658 0.000510132  0.00668208  0.00358996  0.00286506 0.000316181   0.0232658  0.00052351   0.0434742  0.00466304  0.00488598
              0.00112468    0.136152 0.000159306 0.000323201 0.000675101  0.00950934   0.0225233 0.000794942      0.3725   0.0250236  0.00799329     0.24354 0.000878365    0.107365   0.0523892   0.0190483
               0.0229292    0.100401   0.0169836    0.181992  0.00180589   0.0674789   0.0602699    0.133468   0.0914609    0.302551   0.0106088 0.000922524  0.00076425  0.00601274  0.00155276 0.000798371
              0.00406458  0.00771294 0.000858738    0.183722    0.466745   0.0168776  0.00526799   0.0251976   0.0312961   0.0051355 0.000162307    0.229307   0.0181707 0.000108073  0.00452433 0.000849723
               0.0331273 0.000419381   0.0112752   0.0491305  0.00676817   0.0830185    0.147625 0.000208384    0.163793   0.0168933   0.0105609    0.021151    0.219053    0.236292 0.000587126 9.82216e-05
               0.0248403 4.96193e-05 7.61346e-05   0.0547002  0.00281225    0.359926   0.0695453   0.0441113     0.14177   0.0404972    0.106763 0.000207411 0.000153175    0.137722  0.00816595  0.00866017
              0.00266494 0.000414355  0.00142363  0.00431237 0.000331138  0.00778847    0.018396   0.0962329  0.00355192 0.000726338    0.171307  0.00569994  0.00659365  0.00126449     0.60317    0.076123
                0.518667 0.000528908 0.000329119   0.0034696  0.00143919 0.000380646   0.0115064 0.000579649     0.40941   0.0144557   0.0120205 0.000395476   0.0142676  0.00834304  0.00356296 0.000644249
        [INFO]  Write output[0] success. output file = result_files/output_0.bin
        [INFO]  Run op success
        ```

        可见输出结果=Softmax(输入数据1)，Softmax算子验证结果正确。

        result\_files/output\_0.bin：输出数据的二进制文件。

