# 图像分类（输入：图片 输出：图片）

## 简介

深度卷积神经网络AlexNet赢得了2012年ILSVRC的冠军，从那时起，CNN家族就拿下了这一比赛，并超过了人类视觉5%~10%的准确率水平，基于CNN网络模型的图像分类也成为了AI领域最为活跃的研究领域。本应用提供了基于Atlas 200 DK或者AI加速云服务器进行分类网络应用开发的Demo。

本项目是图像分类应用，旨在华为Atlas200DK和AI加速云服务器上实现读取本地图像作为输入，对图像中的物体进行识别分类，并将分类的结果展示出来。本应用能够输入多张待检测的图片，上传至Atlas200DK或是AI加速云服务器，程序读取图片并加载训练好的分类模型进行推理，并将分类结果标注在图片上展示出来。

## 总体设计

![输入图片说明](https://images.gitee.com/uploads/images/2020/0810/152928_dffd1a38_5408865.png "屏幕截图.png")

1. **运行管理资源申请：**用于初始化系统内部资源，ACL固定的调用流程。
2. **加载模型文件并构建输出内存：**从文件加载离线模型数据，需要由用户自行管理模型运行的内存，根据内存中加载的模型获取模型的基本信息包含模型输入、输出数据的数据buffer大小；由模型的基本信息构建模型输出内存，为接下来的模型推理做好准备。
3. **获取本地图像并进行预处理：**从本地存放有图像数据的目录中循环读取图像数据，将图像数据缩放至模型要求的宽高比例；然后构建模型的输入数据。
4. **模型推理：**根据构建好的模型输入数据进行模型推理。
5. **解析推理结果：**根据模型输出，解析图片分类的结果，获取当前图像中识别出的物体类别以及对应的置信度，将分类结果标注在图片上进行展示。





## 模型结构

![输入图片说明](https://images.gitee.com/uploads/images/2020/0810/153018_5bb4f333_5408865.jpeg "googlenet网络结构图.jpg")

## 原始模型

该模型来自GitHub：https://github.com/BVLC/caffe/tree/master/models/bvlc_googlenet 请从GitHub中获取模型网络结构，预训练模型等。

## 图像预处理

该模型算法需要BGR格式，输入图像分辨率为224x224，并对颜色通道进行减均值。本应用图像预处理时opencv和AIPP分工处理：

opencv：

1. imread读取图像数据为BGR
2. 图像缩放为：224x224
3. 输出图像数据类型为：Uint8

AIPP:

1. 颜色通道减均值
2. 图像数据类型转换：Uint8->FP16(达芬奇推理的要求，模型最后实际的输入为fp16)

## 图像后处理

模型的输出为1000个float型数据，1000个float型数据代表1000中物体类别，每个float型数据为归一化数据范围0 ~ 1。代表该类物体识别的置信度，选取其中置信度最高的类别，作为图像的分类结果。

## 案例性能

单次处理时长（预处理->推理->后处理）：17.2 ms

单次推理时长（推理）：3.5 ms

## 可优化点

由性能可以看出，推理速度很快。但是预处理和后处理占用时间过长，导致单次处理时长较长。可以将预处理和后处理进行优化，使用DVPP替换OPENCV，或者使用单算子进行后处理，可以有效提升效率。